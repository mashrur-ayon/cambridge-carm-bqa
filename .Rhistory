####################################
#Install and load necessary package#
####################################
install.packages("tidyverse", "haven", "labelled", "summarytools", "DescTools", "janitor", "forcats")
####################################
#Install and load necessary package#
####################################
install.packages("tidyr")
install.packages("haven")
install.packages("labelled")
install.packages("summarytools")
install.packages("DescTools")
install.packages("janitor")
install.packages("forcats")
data <- BQA_Lab
view(data)
library(tidyverse)
install.packages("tidyverse")
library(tidyverse)
library(dplyr)
library(haven)
library(labelled)
library(summarytools)
library(DescTools)
library(janitor)
library(forcats)
library(tidyverse)
#library(dplyr)
library(haven)
library(labelled)
library(summarytools)
library(DescTools)
library(janitor)
#library(forcats)
view(data)
view(data)
view(data)
data <- BQA_Lab
view(data)
view(data)
data <- data %>% arrange(AGE)
view(data)
data <- BQA_Lab_V2
view(data)
load("BQA_Lab.Rdata")
load("BQA_Lab.Rdata")
data <- BQA_Lab
view(data)
View(data)
View(data)
data <- data %>% arrange(MARSTAT)
View(data)
View(BQA_Lab)
View(data)
names(data)
glimpse(data)
data <- data %>% arrange(MARSTAT, AGE)
View(data)
data <- data %>% select(MARSTAT, AGE, everything())
View(data)
data %>%
group_by(MARSTAT) %>%
summarise(avg_age = mean(AGE, na.rm = TRUE))
ungroup(data)
data %>%
group_by(MARSTAT) %>%
summarise(avg_age = mean(AGE, na.rm = TRUE))%>%
ungroup()
data %>%
group_by(female) %>%
summarise(avg_LifeSat = mean(LifeSat, na.rm = TRUE))%>%
ungroup()
#Check the existing label
levels(data$pplfair)
tabyl(data$pplfair)
#First need to deal with missing data
data <- data %>%
mutate(pplfair_recode = na_if(pplfair, "Refusal")) %>%
mutate(pplfair_recode = na_if(pplfair_recode, "Don't know")) %>%
mutate(pplfair_recode = na_if(pplfair_recode, "No answer")) %>%
mutate(pplfair_recode = droplevels(pplfair_recode))
#Recode the new variable
data <- data %>%
mutate(pplfair_recode = pplfair_recode %>%
fct_collapse(
"Try to take advantage" = c("Most people try to take advantage of me", "1", "2", "3", "4"),
"Neither" = "5",
"Try to be fair" = c("6", "7", "8", "9", "Most people try to be fair")) )
#Label the new variable
attr(data$pplfair_recode, "label") <- "People try to be fair"
#Verify the changes
attributes(data$pplfair_recode)
tabyl(data$pplfair_recode)
#_____________________________________________________________________
#_____________________________________________________________________
#_practice 'wkvlorg' ----
#Check the existing label
levels(data$wkvlorg)
#First need to deal with missing data
data <- data %>%
mutate(wkvlorg_recode = na_if(wkvlorg, "Refusal")) %>%
mutate(wkvlorg_recode = na_if(wkvlorg_recode, "Don't know")) %>%
mutate(wkvlorg_recode = na_if(wkvlorg_recode, "No answer")) %>%
mutate(wkvlorg_recode = droplevels(wkvlorg_recode))
#Recode the new variable
data <- data %>%
mutate(wkvlorg_recode = wkvlorg_recode %>%
fct_collapse(
"Never" = c("Never"),
"Rarely" = c("Less often", "At least once every six months"),
"Occasionally" = c("At least once every three months", "At least once a month"),
"Frequently" = c("At least once a week")))
#Label the new variable
attr(data$wkvlorg_recode, "label") <- "Frequency of volunteering in past 12 months"
#Verify the changes
attributes(data$wkvlorg_recode)
tabyl(data$wkvlorg_recode)
#1.6 RENAMING FACTOR LEVELS ####
#_____________________________________________________________________
#_____________________________________________________________________
#_example 'pplfair_recode' ----
#check levels
levels(data$pplfair_recode)
#Rename levels
data <- data %>%
mutate(pplfair_recode = fct_recode(pplfair_recode,
"Advantage" = "Try to take advantage",
"Neutral" = "Neither",
"Fair" = "Try to be fair"))
#Check new levels
levels(data$pplfair_recode)
#_____________________________________________________________________
#_____________________________________________________________________
#_practice 'economic_status2' ----
#Use code from FiAS to generate the variable
data <- data %>%
mutate(economic_status2 = fct_recode(mnactic,
"Unemployed" = "Unemployed, looking for job",
"Unemployed" = "Unemployed, not looking for job",
"Economically inactive" = "Permanently sick or disabled",
"Economically inactive" = "Retired",
"Economically inactive" = "Community or military service",
"Economically inactive" = "Housework, looking after children, others",
"Economically inactive" = "Other",
NULL = "Not applicable",
NULL = "Refusal",
NULL = "Don't know",
NULL = "No answer"
))
#check levels
levels(data$economic_status2)
#Rename levels
data <- data %>%
mutate(economic_status2 = fct_recode(economic_status2,
"Working" = "Paid work",
"Student" = "Education",
"Job seeker" = "Unemployed",
"Not in labor force" = "Economically inactive"))
#check new levels
levels(data$economic_status2)
#1.8 USING LOGICAL OPERATORS AND A SINGLE VARIABLE TO CREATE A NEW VARIABLE ####
#_ifelse ----
#Create character variable
data <- data %>%
mutate(adult = ifelse(AGE >= 18, "Adult", "Not Adult"))
#Create binary factor variable
data <- data %>%
mutate(adult = ifelse(AGE >= 18, "Adult", "Not Adult"),
adult = factor(adult, levels = c("Not Adult","Adult")))
#_case_when ----
#Create factor variable
data <- data %>%
mutate(age_group = case_when(
AGE < 18 ~ "Child",
AGE >= 18 & AGE <= 64 ~ "Adult",
AGE > 64 ~ "Senior",
TRUE ~ NA_character_
) %>% factor(levels = c("Child", "Adult", "Senior")))
#_!is.na ----
#Using !is.na within another function
data %>%
filter(!is.na(AnnInc)) %>%
select(AGE, LifeSat ) %>%
descr()
#Using !is.na when creating new variables
data <- data %>%
mutate(status = case_when(
is.na(AGE) ~ "Missing Age",
AGE >= 18 ~ "Adult",
TRUE ~ "Child"
) %>% factor(levels = c("Child", "Adult", "Missing Age")))
#1.9 CREATING NEW VARIABLES USING MULTIPLE VARIABLES AND CONDITIONS ####
data <- data %>%
mutate(oldman = case_when(
is.na(gndr) | is.na(AGE) ~ NA_character_,
gndr == "Male" & AGE >= 70 ~ "Old Man",
TRUE ~ "Not Old Man" ) %>%
factor(levels = c("Old Man", "Not Old Man")))
data %>%
tabyl(oldman, gndr)
descr(data$AGE[data$oldman == "Old Man"])
descr(data$AGE[data$oldman == "Not Old Man"])
data %>%
group_by(oldman) %>%
summarise(
avg_age = mean(AGE, na.rm = TRUE),
min_age = min(AGE),
max_age = max(AGE),
n=n()
) %>%
ungroup()
#1.10 PRACTICE EXERCISE ####
#_____________________________________________________________________
#____________________________________________________________________
# Create the 'happyparent' variable
data <- data %>%
mutate(
happyparent = case_when(
# Handle missing values for either children or happiness
chldhm %in% c("Not available") |
happy %in% c("Refusal", "Don't know", "No answer") ~ NA_character_,
# Happy parent: lives with children and reports happiness of 9 or 10
chldhm == "Respondent lives with children at household grid" &
(happy == "9" | happy == "Extremely happy") ~ "YES",
# Not a happy parent: lives with children but does not report high happiness
chldhm == "Respondent lives with children at household grid" &
!(happy == "9" | happy == "Extremely happy") ~ "NO",
# Does not live with children
chldhm == "Does not" ~ "NO",
TRUE ~ NA_character_  # Catch any other remaining missing values
) %>% factor(levels = c("NO", "YES"))
)
#To check 4875 happy parents and 402 missing
data %>%
tabyl(happyparent)
#To check respondents are correctly categorised based on whether they live with children
data %>%
tabyl(happyparent, chldhm)
#To check respondents are correctly categorised based on their happiness level
data %>%
tabyl(happy, happyparent)
library(tidyverse)
library(haven)
library(labelled)
library(summarytools)
library(janitor)
library(sjPlot)
data %>%
tabyl(MARSTAT, LONELY)
data <-data %>%
mutate(LONELY2 = droplevels(LONELY))
data %>%
tabyl(MARSTAT, LONELY2)
data %>%
filter(complete.cases(MARSTAT, LONELY2)) %>%  # Filter out rows with any NA values
tabyl(MARSTAT, LONELY2)  # Create the cross-tab
data %>%
filter(complete.cases(MARSTAT, LONELY2)) %>%  # Filter out rows with any NA values
tabyl(MARSTAT, LONELY2) %>%   # Create the cross-tab
adorn_totals(c("row", "col"))
data %>%
filter(complete.cases(MARSTAT, LONELY2)) %>%  # Filter out NA values
tabyl(MARSTAT, LONELY2) %>%
adorn_totals(c("row", "col")) %>% #Display row and column totals
adorn_percentages("row") %>% # Display row percentages
adorn_pct_formatting()  # Optionally format the percentages nicely
# _Display column percentages ----
data %>%
filter(complete.cases(MARSTAT, LONELY2)) %>%  # Filter out NA values
tabyl(MARSTAT, LONELY2) %>%
adorn_totals(c("row", "col")) %>% #Display row and column totals
adorn_percentages("col") %>% # Display column percentages
adorn_pct_formatting()  # Optionally format the percentages nicely
data %>%
filter(complete.cases(MARSTAT, LONELY2)) %>%  # Filter out NA values
tabyl(MARSTAT, LONELY2) %>%
adorn_totals(c("row", "col")) %>% #Display row and column totals
adorn_percentages("col") %>% # Display column percentages
adorn_pct_formatting()  # Optionally format the percentages nicely
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#_Display BOTH frequencies AND percentages ----
data %>%
filter(complete.cases(MARSTAT, LONELY2)) %>%  # Filter out NA values
tabyl(MARSTAT, LONELY2) %>%
adorn_totals(c("row", "col")) %>% #Display row and column totals
adorn_percentages("row") %>% # Display row percentages
adorn_pct_formatting()  %>% # Optionally format the percentages nicely
adorn_ns() #Display number of observations
View(data)
View(data)
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#_Using ctable() ----
#tabyl() works, but the code is getting quite verbose
#simplify coding using ctable() from summarytools package
ctable(data$MARSTAT, data$LONELY2,
totals = TRUE, #display both row and column totals
useNA = "no",  #no longer have to filter out missing
prop = "r",    #row percentages
round.digits =2 ) #show proportions to 2 decimal places
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#_Change order of variables ----
# Cross-tabulations: see what happens when you change order of variables
ctable(data$LONELY2, data$MARSTAT,
totals = TRUE, #display both row and column totals
useNA = "no",  #no longer have to filter out missing
prop = "r",    #row percentages
round.digits =2 ) #show proportions to 2 decimal places
#_Preparing the variables ----
#Check both variables to see if any missing values need managing
data %>%
select(LRSCALE2, FREEHMS) %>%
dfSummary() %>%
view()
# Empty levels are being displayed for FREEHMS
#Generate FREEHMS2 which drops the empty levels from the factor
data <-data %>%
mutate(FREEHMS2 = droplevels(FREEHMS))
# Empty levels are being displayed for FREEHMS
#Generate FREEHMS2 which drops the empty levels from the factor
data <-data %>%
mutate(FREEHMS2 = droplevels(FREEHMS))
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# _Row percentages ----
ctable(data$LRSCALE2, data$FREEHMS2,
totals = TRUE,
useNA = "no",
prop = "r",
round.digits = 2)
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# _Column percentages ----
ctable(data$LRSCALE2, data$FREEHMS2,
totals = TRUE,
useNA = "no",
prop = "c",
round.digits = 2)
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#_Total percentages ----
#  (this isn't commonly used but is an option)
ctable(data$LRSCALE2, data$FREEHMS2,
totals = TRUE,
useNA = "no",
prop = "t",
round.digits = 2)
dfSummary()
dfSummary()
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#_tab_xtab function ----
#tabyl() and ctable() won't display row and column percentages at the same time
#Use a different package - tab_xtab from sjPlot
#displays in the viewer not console
data %>%
filter(complete.cases(LRSCALE2, FREEHMS2)) %>%
{ tab_xtab(.$LRSCALE2, .$FREEHMS2,
show.obs = TRUE,
show.row.prc = TRUE,
show.col.prc = TRUE) }
#Can add cell percentages as well
data %>%
filter(complete.cases(LRSCALE2, FREEHMS2)) %>%
{ tab_xtab(.$LRSCALE2, .$FREEHMS2,
show.obs = TRUE,
show.row.prc = TRUE,
show.col.prc = TRUE,
show.cell.prc = TRUE) }
ctable(data$MARSTAT, data$LONELY2,
totals = TRUE, #display both row and column totals
useNA = "no",  #no longer have to filter out missing
prop = "r",    #row percentages
round.digits =2, #show proportions to 2 decimal places
chisq = TRUE) #displays results from chi-square test
df70 <- data %>%
filter(AGE >= 70)
ctable(df70$MARSTAT, df70$LONELY2,
totals = TRUE,
useNA = "no",
prop = "r",
round.digits = 2,
chisq = TRUE)
#Nicely formatted output
ctable(df70$MARSTAT, df70$LONELY2,
totals = TRUE,
useNA = "no",
prop = "r",
round.digits = 2,
chisq = TRUE)  %>%
view()
###########################################
###Another option - tab_xtab from sjPlot###
###########################################
data %>%
filter(AGE >= 70) %>%
{ tab_xtab(.$MARSTAT, .$LONELY2,
show.obs = TRUE,
show.row.prc = TRUE,
show.summary = TRUE) }
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ___below age 22 ----
#For those below age 22
df22 <- data %>%
filter(AGE < 22)
ctable(df22$MARSTAT, df22$LONELY2,
totals = TRUE,
useNA = "no",
prop = "r",
round.digits = 2,
chisq = TRUE)
#Nicely formatted output
ctable(df22$MARSTAT, df22$LONELY2,
totals = TRUE,
useNA = "no",
prop = "r",
round.digits = 2,
chisq = TRUE )  %>%
view()
setwd("~/GitHub/cambridge-carm-bqa")
###########################################
###Another option - tab_xtab from sjPlot###
###########################################
data %>%
filter(AGE >= 70) %>%
{ tab_xtab(.$MARSTAT, .$LONELY2,
show.obs = TRUE,
show.row.prc = TRUE,
show.summary = TRUE) }
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ___below age 22 ----
#For those below age 22
df22 <- data %>%
filter(AGE < 22)
ctable(df22$MARSTAT, df22$LONELY2,
totals = TRUE,
useNA = "no",
prop = "r",
round.digits = 2,
chisq = TRUE)
#Nicely formatted output
ctable(df22$MARSTAT, df22$LONELY2,
totals = TRUE,
useNA = "no",
prop = "r",
round.digits = 2,
chisq = TRUE )  %>%
view()
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ___below age 22 ----
#For those below age 22
df22 <- data %>%
filter(AGE < 22)
ctable(df22$MARSTAT, df22$LONELY2,
totals = TRUE,
useNA = "no",
prop = "r",
round.digits = 4,
chisq = TRUE)
#Nicely formatted output
ctable(df22$MARSTAT, df22$LONELY2,
totals = TRUE,
useNA = "no",
prop = "r",
round.digits = 2,
chisq = TRUE )  %>%
view()
ctable(df22$MARSTAT, df22$LONELY2,
totals = TRUE,
useNA = "no",
prop = "r",
round.digits = 2,
chisq = TRUE)
#Another option - tab_xtab from sjPlot
data %>%
filter(AGE <22) %>%
{ tab_xtab(.$MARSTAT, .$LONELY2,
show.obs = TRUE,
show.row.prc = TRUE,
show.summary = TRUE) }
#2.5 - GROUPING DATA - OPTIONAL ACTIVITY ####
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#_No grouping ----
#First examine for entire sample (same code as earlier)
ctable(data$LRSCALE2, data$FREEHMS2,
totals = TRUE,
useNA = "no",
prop = "r",
round.digits =2,
chisq = TRUE )
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Grouping with ctable()
#Only ctable works with grouped data, layout of command is slightly different
#to what you've seen before
#Output in console
with(data,
stby(data    = list(x = LRSCALE2, y = FREEHMS2),
INDICES = COUNTRY,
FUN     = ctable,
totals = TRUE,
useNA = "no",
prop = "r",
round.digits = 2,
chisq = TRUE
))
# _Displaying output in viewer
with(data,
stby(data    = list(x = LRSCALE2, y = FREEHMS2),
INDICES = COUNTRY,
FUN     = ctable,
totals = TRUE,
useNA = "no",
prop = "r",
round.digits = 2,
chisq = TRUE
)) %>%
view()
